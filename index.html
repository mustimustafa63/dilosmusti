<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sadece Dilara'ya | Ultimate Fixed ❤️</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Sacramento&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <style>
        /* --- 1. CORE STYLES --- */
        :root {
            --primary: #ff0a43;
            --gold: #ffd700;
            --bg: #050505;
            --glass: rgba(20, 20, 20, 0.85);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Montserrat', sans-serif; color: white; background: var(--bg);
            overflow: hidden; height: 100vh; width: 100vw;
        }

        /* --- 2. VIEW MANAGEMENT --- */
        .view-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            transition: opacity 0.5s ease, transform 0.5s ease;
            opacity: 0; pointer-events: none; transform: scale(0.95); z-index: 0;
        }
        .view-layer.active {
            opacity: 1; pointer-events: auto; transform: scale(1); z-index: 5;
        }
        
        #view-site { background: radial-gradient(circle at center, #1a0000 0%, #000000 90%); overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth; }
        #view-3d { background: black; overflow: hidden; }

        /* --- 3. NAVIGATION --- */
        #navbar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 550px; height: 70px;
            background: rgba(10, 10, 10, 0.95); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px; display: flex; align-items: center; z-index: 1000;
            padding: 0 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            overflow-x: auto; gap: 15px;
        }
        #navbar::-webkit-scrollbar { display: none; }
        
        .nav-item {
            color: #666; font-size: 1.2rem; cursor: pointer; transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; min-width: 60px;
        }
        .nav-item span { font-size: 0.55rem; margin-top: 4px; font-weight: 700; white-space: nowrap; text-transform: uppercase; }
        .nav-item.active { color: var(--gold); transform: translateY(-2px); }
        .nav-item.active i { text-shadow: 0 0 10px var(--gold); }

        /* --- 4. SITE SECTIONS --- */
        .section {
            height: 100vh; width: 100%; scroll-snap-align: start;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 60px 20px 100px 20px;
        }
        h2 { font-family: 'Sacramento', cursive; font-size: 3rem; color: var(--gold); margin-bottom: 20px; }
        .glass-card {
            background: var(--glass); border: 1px solid rgba(255,215,0,0.1); border-radius: 20px;
            padding: 20px; width: 100%; max-width: 400px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* --- 5. 3D UI OVERLAY --- */
        #ui-3d { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        #header-3d { position: absolute; top: 30px; width: 100%; text-align: center; text-shadow: 0 0 15px var(--primary); }
        #status-3d { 
            position: absolute; bottom: 100px; width: 100%; text-align: center; color: #fff; font-size: 0.9rem; font-weight: bold; text-shadow: 0 0 5px black;
        }
        #pip-container { 
            position: absolute; bottom: 100px; right: 20px; width: 80px; height: 100px; 
            border: 2px solid var(--primary); border-radius: 10px; overflow: hidden; background: #222;
        }
        #pip-canvas { width: 100%; height: 100%; transform: scaleX(-1); }
        #btn-start-3d {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; color: black; border: none; padding: 15px 40px; font-weight: bold;
            pointer-events: auto; cursor: pointer; border-radius: 30px; z-index: 200;
        }

        /* EXTRAS */
        .neon-heart { width: 150px; fill: var(--primary); filter: drop-shadow(0 0 15px var(--primary)); animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100% {transform:scale(1)} 50% {transform:scale(1.1)} }
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .photo { height: 120px; background-size: cover; border-radius: 10px; }
        
        /* VIDEO FIX: Ne pas utiliser display:none, mais opacity:0 */
        #webcam-video { position: fixed; top: 0; left: 0; opacity: 0; pointer-events: none; z-index: -1; width: 1px; height: 1px; }
    </style>
</head>
<body>

    <nav id="navbar">
        <div class="nav-item active" onclick="goSite('home')"><i class="fas fa-heart"></i><span>Aşkım</span></div>
        <div class="nav-item" onclick="goSite('timer')"><i class="fas fa-clock"></i><span>Zaman</span></div>
        <div class="nav-item" onclick="goSite('album')"><i class="fas fa-images"></i><span>Albüm</span></div>
        <div class="nav-item" onclick="goSite('capsule')"><i class="fas fa-envelope"></i><span>Mesaj</span></div>
        <div class="nav-item" onclick="goMode('reactor')" style="color: var(--primary);"><i class="fas fa-atom"></i><span>Reaktör</span></div>
        <div class="nav-item" onclick="goMode('hologram')" style="color: #00e5ff;"><i class="fas fa-cube"></i><span>Hologram</span></div>
    </nav>

    <main id="view-site" class="view-layer active">
        <section id="home" class="section">
            <h1 style="font-family:'Sacramento', cursive; font-size:4.5rem; color:var(--primary); margin-bottom:10px;">Dilara</h1>
            <svg class="neon-heart" viewBox="0 0 512 512"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>
            <p style="margin-top:20px; font-style:italic; color:#ccc;">"Benim dünyam sensin."</p>
            <i class="fas fa-chevron-down" style="margin-top:50px; opacity:0.5; animation:pulse 2s infinite"></i>
        </section>

        <section id="timer" class="section">
            <h2>Bizim Zamanımız</h2>
            <div class="glass-card">
                <p style="color:#888; margin-bottom:15px;">13 Kasım 2024'ten beri...</p>
                <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.2rem;">
                    <div><div id="d">0</div><div style="font-size:0.6rem; color:#666">GÜN</div></div>
                    <div><div id="h">0</div><div style="font-size:0.6rem; color:#666">SAAT</div></div>
                    <div><div id="m">0</div><div style="font-size:0.6rem; color:#666">DK</div></div>
                    <div><div id="s">0</div><div style="font-size:0.6rem; color:#666">SN</div></div>
                </div>
            </div>
        </section>

        <section id="album" class="section">
            <h2>Anılarımız</h2>
            <div class="glass-card">
                <div class="photo-grid">
                    <div class="photo" style="background-image: url('https://images.unsplash.com/photo-1516589178581-6cd7833ae3b2?w=300')"></div>
                    <div class="photo" style="background-image: url('https://images.unsplash.com/photo-1511895426328-dc8714191300?w=300')"></div>
                    <div class="photo" style="background-image: url('https://images.unsplash.com/photo-1529333166437-7750a6dd5a70?w=300')"></div>
                    <div class="photo" style="background-image: url('https://images.unsplash.com/photo-1516589178581-6cd7833ae3b2?w=300')"></div>
                </div>
            </div>
        </section>

        <section id="capsule" class="section">
            <h2>Mesajın</h2>
            <div class="glass-card">
                <p id="msg-text" style="font-style:italic; min-height:60px; display:flex; align-items:center; justify-content:center;">"Butona bas aşkım..."</p>
                <button onclick="openMsg()" style="padding:10px 30px; background:white; color:black; border:none; border-radius:20px; font-weight:bold;">AÇ</button>
            </div>
        </section>
    </main>

    <div id="view-3d" class="view-layer">
        <div id="canvas-container" style="width:100%; height:100%;"></div>
        
        <div id="ui-3d">
            <div id="header-3d">
                <h2 id="mode-title" style="font-size:1.5rem; letter-spacing:5px; margin:0;">REAKTÖR</h2>
                <p style="font-size:0.7rem; color:var(--primary);">SYSTEM ONLINE</p>
            </div>
            <div id="status-3d">En attente d'initialisation...</div>
            <div id="pip-container"><canvas id="pip-canvas"></canvas></div>
            <button id="btn-start-3d" onclick="init3DSystem()">KAMERA BAŞLAT</button>
        </div>
    </div>

    <video id="webcam-video" playsinline muted></video>

    <script>
        // === GLOBAL VARIABLES ===
        let currentMode = 'site';
        let scene, camera, renderer, particles, geometry;
        let animationId, cameraUtils, hands;
        let is3DInitialized = false;
        
        let targetPositions = [], originalPositions = [], randomPositions = [];
        let expansionFactor = 1.0;
        let targetExpansion = 1.0;
        let pulseTime = 0;

        const PHOTO_URL = 'photo.jpg'; 
        const PARTICLE_COUNT = 7000;
        const REACTION_SPEED = 0.3;

        // === 1. NAVIGATION ===
        function goSite(sectionId) {
            switchView('view-site');
            document.getElementById(sectionId).scrollIntoView({ behavior: 'smooth' });
            updateNavUI(sectionId);
            // On ne coupe pas la 3D pour éviter de devoir recharger la caméra à chaque fois, on la met juste en pause
        }

        function goMode(mode) {
            currentMode = mode;
            switchView('view-3d');
            const title = document.getElementById('mode-title');
            if(mode === 'reactor') {
                title.innerText = "KALP REAKTÖRÜ"; title.style.color = "#ff0a43";
            } else {
                title.innerText = "FOTOĞRAF HOLOGRAMI"; title.style.color = "#00e5ff";
            }
            // Si pas encore initialisé, montrer le bouton
            if(!is3DInitialized) {
                document.getElementById('btn-start-3d').style.display = 'block';
            } else {
                // Si déjà init, on relance juste l'anim si on avait changé de mode
                if(mode === 'hologram') loadHologramImage();
                else setupReactor();
            }
            updateNavUI(mode);
        }

        function switchView(viewId) {
            document.querySelectorAll('.view-layer').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function updateNavUI(id) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if(item.onclick.toString().includes(id)) item.classList.add('active');
            });
        }

        // === 2. 3D SYSTEM ===
        function init3DSystem() {
            const btn = document.getElementById('btn-start-3d');
            btn.innerText = "CHARGEMENT...";
            
            const container = document.getElementById('canvas-container');
            container.innerHTML = ''; 

            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.003);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 100;
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);

            // Start everything
            startCamera(); 
            
            if (currentMode === 'reactor') setupReactor();
            else loadHologramImage();
            
            animate();
            
            is3DInitialized = true;
            btn.style.display = 'none';
        }

        // --- REACTOR ---
        function setupReactor() {
            if(particles) scene.remove(particles);
            
            geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(PARTICLE_COUNT * 3);
            const colors = new Float32Array(PARTICLE_COUNT * 3);
            targetPositions = [];

            const c1 = new THREE.Color(0xff0040);

            for(let i=0; i<PARTICLE_COUNT; i++) {
                const t = Math.random() * Math.PI * 2;
                const d = Math.pow(Math.random(), 0.5);
                let x = 16 * Math.pow(Math.sin(t), 3);
                let y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                let z = (Math.random() - 0.5) * 12 * d;

                const ix = i*3;
                targetPositions[ix] = x * 1.5 * d;
                targetPositions[ix+1] = y * 1.5 * d;
                targetPositions[ix+2] = z * 1.5 * d;

                positions[ix] = (Math.random()-0.5)*500;
                positions[ix+1] = (Math.random()-0.5)*500;
                positions[ix+2] = (Math.random()-0.5)*500;

                colors[ix] = c1.r; colors[ix+1] = c1.g; colors[ix+2] = c1.b;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const sprite = createTexture('#ff0040');
            const material = new THREE.PointsMaterial({ size: 2.5, map: sprite, vertexColors: true, blending: THREE.AdditiveBlending, depthWrite: false, transparent: true, opacity: 0.9 });
            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        // --- HOLOGRAM ---
        function loadHologramImage() {
            const img = new Image();
            img.src = PHOTO_URL;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxW = 200; 
                const scale = maxW / img.width;
                canvas.width = maxW; canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                try {
                    const data = ctx.getImageData(0,0,canvas.width, canvas.height);
                    createHologramParticles(data);
                } catch(e) { 
                    document.getElementById('status-3d').innerText = "Erreur: Lancez avec un serveur local!";
                }
            };
            img.onerror = () => document.getElementById('status-3d').innerText = "Erreur: photo.jpg manquante";
        }

        function createHologramParticles(imageData) {
            if(particles) scene.remove(particles);
            
            const w = imageData.width; const h = imageData.height;
            const data = imageData.data;
            
            geometry = new THREE.BufferGeometry();
            const count = w*h;
            const positions = new Float32Array(count * 3);
            const cols = new Float32Array(count * 3);
            originalPositions = new Float32Array(count * 3);
            randomPositions = new Float32Array(count * 3);
            
            let idx = 0;
            const startX = -w/2; const startY = h/2;

            for(let y=0; y<h; y++) {
                for(let x=0; x<w; x++) {
                    const i = (y*w + x) * 4;
                    if(data[i+3] > 50) { 
                        const r = data[i]/255; const g = data[i+1]/255; const b = data[i+2]/255;
                        const pz = (r+g+b)/3 * 10; 
                        const px = (startX + x) * 0.8;
                        const py = (startY - y) * 0.8;

                        originalPositions[idx*3] = px;
                        originalPositions[idx*3+1] = py;
                        originalPositions[idx*3+2] = pz;

                        randomPositions[idx*3] = (Math.random()-0.5)*800;
                        randomPositions[idx*3+1] = (Math.random()-0.5)*800;
                        randomPositions[idx*3+2] = (Math.random()-0.5)*800;

                        positions[idx*3] = px;
                        positions[idx*3+1] = py;
                        positions[idx*3+2] = pz;

                        cols[idx*3] = r; cols[idx*3+1] = g; cols[idx*3+2] = b;
                        idx++;
                    }
                }
            }
            
            const finalPos = positions.slice(0, idx*3);
            const finalCols = cols.slice(0, idx*3);
            geometry.setAttribute('position', new THREE.BufferAttribute(finalPos, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(finalCols, 3));

            const sprite = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/disc.png');
            const material = new THREE.PointsMaterial({ size: 1.5, map: sprite, vertexColors: true, alphaTest: 0.5, transparent: true });
            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        // --- ANIMATION ---
        function animate() {
            animationId = requestAnimationFrame(animate);
            if(!particles) return;

            if (currentMode === 'reactor') particles.rotation.y += 0.003;
            else { particles.rotation.y = 0; particles.rotation.x = 0; }

            const positions = geometry.attributes.position.array;
            expansionFactor += (targetExpansion - expansionFactor) * REACTION_SPEED;

            if (currentMode === 'reactor') {
                for(let i=0; i<positions.length/3; i++) {
                    const ix = i*3;
                    const tx = targetPositions[ix] * expansionFactor;
                    const ty = targetPositions[ix+1] * expansionFactor;
                    const tz = targetPositions[ix+2] * expansionFactor;
                    
                    positions[ix] += (tx - positions[ix]) * REACTION_SPEED;
                    positions[ix+1] += (ty - positions[ix+1]) * REACTION_SPEED;
                    positions[ix+2] += (tz - positions[ix+2]) * REACTION_SPEED;
                }
            } else {
                const ratio = expansionFactor; 
                for(let i=0; i<positions.length/3; i++) {
                    const ix = i*3;
                    const x = originalPositions[ix] + (randomPositions[ix] - originalPositions[ix]) * ratio;
                    const y = originalPositions[ix+1] + (randomPositions[ix+1] - originalPositions[ix+1]) * ratio;
                    const z = originalPositions[ix+2] + (randomPositions[ix+2] - originalPositions[ix+2]) * ratio;
                    positions[ix] = x; positions[ix+1] = y; positions[ix+2] = z;
                }
            }
            geometry.attributes.position.needsUpdate = true;
            renderer.render(scene, camera);
        }

        // --- CAMERA ---
        function startCamera() {
            const video = document.getElementById('webcam-video');
            const canvas = document.getElementById('pip-canvas');
            const ctx = canvas.getContext('2d');
            const status = document.getElementById('status-3d');
            
            status.innerText = "Chargement IA Mains...";

            hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({maxNumHands: 2, modelComplexity: 0, minDetectionConfidence: 0.4, minTrackingConfidence: 0.4});
            
            hands.onResults((results) => {
                ctx.clearRect(0,0,80,100);
                ctx.drawImage(results.image, 0, 0, 80, 100);
                if(results.multiHandLandmarks) {
                    for(const l of results.multiHandLandmarks) drawConnectors(ctx, l, HAND_CONNECTIONS, {color: '#00ff00', lineWidth: 1});
                }

                if(results.multiHandLandmarks.length > 0) {
                    status.innerText = "CONNEXION ÉTABLIE";
                    status.style.color = "#00ffaa";

                    // Logique pour 1 ou 2 mains
                    let val = 0;
                    if(results.multiHandLandmarks.length === 2) {
                        const h1 = results.multiHandLandmarks[0][8];
                        const h2 = results.multiHandLandmarks[1][8];
                        const dist = Math.sqrt(Math.pow(h1.x-h2.x, 2) + Math.pow(h1.y-h2.y, 2));
                        val = dist * 5.0; // Sensibilité
                    } else {
                        // 1 main = petite réaction
                        val = 0.5;
                    }

                    if(currentMode === 'reactor') {
                        if(val < 0.8) val = 0.8; if(val > 5.0) val = 5.0;
                        targetExpansion = val;
                    } else {
                        // Hologram: 0 = Intact, 1 = Explode
                        // Si 2 mains s'écartent -> dist augmente -> val augmente
                        if(results.multiHandLandmarks.length === 2) {
                             // Mapping: distance 0.1 -> 0, distance 0.5 -> 1
                             let ratio = (val / 5.0 - 0.2) * 3.0;
                             if(ratio < 0) ratio = 0; if(ratio > 1) ratio = 1;
                             targetExpansion = ratio;
                        } else {
                            targetExpansion = 0; // 1 main = stable
                        }
                    }
                } else {
                    status.innerText = "Montrez vos mains...";
                    status.style.color = "#fff";
                    
                    if(currentMode === 'reactor') {
                        pulseTime += 0.15; targetExpansion = 1.0 + Math.sin(pulseTime)*0.2;
                    } else {
                        targetExpansion = 0;
                    }
                }
            });

            const cameraObj = new Camera(video, {
                onFrame: async () => { await hands.send({image: video}); },
                width: 320, height: 240, facingMode: 'user'
            });
            
            status.innerText = "Démarrage vidéo...";
            cameraObj.start()
                .then(() => { status.innerText = "Analyse en cours..."; })
                .catch(err => { 
                    console.error(err); 
                    status.innerText = "Erreur Caméra (HTTPS requis?)";
                    alert("Erreur: La caméra ne peut pas démarrer. Vérifiez que vous êtes en HTTPS.");
                });
                
            cameraUtils = cameraObj;
        }

        // --- UTILS ---
        function createTexture(colorHex) {
            const c = document.createElement('canvas'); c.width=64; c.height=64;
            const cx = c.getContext('2d');
            const g = cx.createRadialGradient(16,16,0,16,16,16);
            g.addColorStop(0, colorHex); g.addColorStop(0.4, colorHex); g.addColorStop(1, 'rgba(0,0,0,0)');
            cx.fillStyle = g; cx.fillRect(0,0,32,32);
            const t = new THREE.Texture(c); t.needsUpdate = true;
            return t;
        }

        // --- SITE JS ---
        const start = new Date('2024-11-13T00:00:00').getTime();
        setInterval(() => {
            const diff = new Date().getTime() - start;
            document.getElementById('d').innerText = Math.floor(diff/(1000*60*60*24));
            document.getElementById('h').innerText = Math.floor((diff%(1000*60*60*24))/(1000*60*60));
            document.getElementById('m').innerText = Math.floor((diff%(1000*60*60))/(1000*60));
            document.getElementById('s').innerText = Math.floor((diff%(1000*60))/1000);
        }, 1000);

        const msgs = ["Senin gülüşün...", "Her anım seninle...", "Seni çok seviyorum", "İyi ki varsın"];
        function openMsg() {
            const el = document.getElementById('msg-text'); el.style.opacity = 0;
            setTimeout(()=>{el.innerText = msgs[Math.floor(Math.random()*msgs.length)]; el.style.opacity=1},300);
        }

        window.addEventListener('resize', () => {
            if(camera && renderer) {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>
