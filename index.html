<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sadece Dilara'ya | Ultimate Fixed V2 ❤️</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Sacramento&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <style>
        :root { --primary: #ff0a43; --gold: #ffd700; --bg: #050505; --glass: rgba(20, 20, 20, 0.85); }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Montserrat', sans-serif; color: white; background: var(--bg); overflow: hidden; height: 100vh; width: 100vw; }

        .view-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: opacity 0.5s; opacity: 0; pointer-events: none; z-index: 0; }
        .view-layer.active { opacity: 1; pointer-events: auto; z-index: 5; }
        
        #view-site { background: radial-gradient(circle at center, #1a0000 0%, #000000 90%); overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth; }
        #view-3d { background: black; overflow: hidden; }

        /* NAV */
        #navbar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; height: 70px; background: rgba(10, 10, 10, 0.95); border-radius: 25px; display: flex; align-items: center; z-index: 1000; padding: 0 10px; overflow-x: auto; gap: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .nav-item { color: #666; font-size: 1.2rem; display: flex; flex-direction: column; align-items: center; min-width: 60px; transition: 0.3s; }
        .nav-item.active { color: var(--gold); transform: translateY(-2px); }
        .nav-item span { font-size: 0.55rem; margin-top: 4px; font-weight: 700; text-transform: uppercase; }

        /* SECTIONS */
        .section { height: 100vh; width: 100%; scroll-snap-align: start; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .glass-card { background: var(--glass); border: 1px solid rgba(255,215,0,0.1); border-radius: 20px; padding: 20px; width: 100%; max-width: 400px; text-align: center; }
        
        /* 3D UI */
        #ui-3d { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        #header-3d { position: absolute; top: 30px; width: 100%; text-align: center; }
        #status-3d { position: absolute; bottom: 110px; width: 100%; text-align: center; color: #fff; font-weight: bold; text-shadow: 0 0 5px black; }
        
        /* PIP CAM (CORRIGÉ) */
        #pip-container { 
            position: absolute; bottom: 100px; right: 20px; width: 100px; height: 133px; 
            border: 2px solid var(--primary); border-radius: 10px; overflow: hidden; background: #000;
            z-index: 20; pointer-events: none;
        }
        #pip-canvas { width: 100%; height: 100%; transform: scaleX(-1); object-fit: cover; }
        
        #btn-start-3d { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; color: black; border: none; padding: 15px 40px; font-weight: bold; pointer-events: auto; cursor: pointer; border-radius: 30px; z-index: 200; }

        /* EXTRAS */
        .neon-heart { width: 150px; fill: var(--primary); animation: pulse 1s infinite; filter: drop-shadow(0 0 10px var(--primary)); }
        @keyframes pulse { 0%,100% {transform:scale(1)} 50% {transform:scale(1.1)} }
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .photo { height: 120px; background-size: cover; border-radius: 10px; }
        
        video { display: none; }
    </style>
</head>
<body>

    <nav id="navbar">
        <div class="nav-item active" onclick="goSite('home')"><i class="fas fa-heart"></i><span>Aşkım</span></div>
        <div class="nav-item" onclick="goSite('timer')"><i class="fas fa-clock"></i><span>Zaman</span></div>
        <div class="nav-item" onclick="goSite('album')"><i class="fas fa-images"></i><span>Albüm</span></div>
        <div class="nav-item" onclick="goSite('capsule')"><i class="fas fa-envelope"></i><span>Mesaj</span></div>
        <div class="nav-item" onclick="goMode('reactor')" style="color: var(--primary);"><i class="fas fa-atom"></i><span>Reaktör</span></div>
        <div class="nav-item" onclick="goMode('hologram')" style="color: #00e5ff;"><i class="fas fa-cube"></i><span>Hologram</span></div>
    </nav>

    <main id="view-site" class="view-layer active">
        <section id="home" class="section">
            <h1 style="font-family:'Sacramento', cursive; font-size:4.5rem; color:var(--primary);">Dilara</h1>
            <svg class="neon-heart" viewBox="0 0 512 512"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>
            <p style="margin-top:20px; font-style:italic;">"Benim dünyam sensin."</p>
        </section>

        <section id="timer" class="section">
            <h2>Zaman</h2>
            <div class="glass-card">
                <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.2rem;">
                    <div><div id="d">0</div><span>GÜN</span></div>
                    <div><div id="h">0</div><span>SAAT</span></div>
                    <div><div id="m">0</div><span>DK</span></div>
                    <div><div id="s">0</div><span>SN</span></div>
                </div>
            </div>
        </section>

        <section id="album" class="section">
            <h2>Anılarımız</h2>
            <div class="glass-card">
                <div class="photo-grid">
                    <div class="photo" style="background-image: url('https://images.unsplash.com/photo-1516589178581-6cd7833ae3b2?w=300')"></div>
                    <div class="photo" style="background-image: url('https://images.unsplash.com/photo-1511895426328-dc8714191300?w=300')"></div>
                </div>
            </div>
        </section>

        <section id="capsule" class="section">
            <h2>Mesaj</h2>
            <div class="glass-card">
                <p id="msg-text" style="font-style:italic; min-height:50px;">"Butona bas..."</p>
                <button onclick="openMsg()" style="padding:10px 30px; background:white; border:none; border-radius:20px; font-weight:bold;">AÇ</button>
            </div>
        </section>
    </main>

    <div id="view-3d" class="view-layer">
        <div id="canvas-container" style="width:100%; height:100%;"></div>
        <div id="ui-3d">
            <div id="header-3d"><h2 id="mode-title" style="font-size:1.5rem;">REAKTÖR</h2></div>
            <div id="status-3d">En attente...</div>
            <div id="pip-container"><canvas id="pip-canvas"></canvas></div>
            <button id="btn-start-3d" onclick="init3DSystem()">LANCER</button>
        </div>
    </div>

    <video id="webcam-video" playsinline muted></video>

    <script>
        // CONFIG
        const PHOTO_URL = 'photo.jpg'; 
        const PARTICLE_COUNT = 7000;
        const REACTION_SPEED = 0.4; // ULTRA REACTIF

        // VARS
        let currentMode = 'site';
        let scene, camera, renderer, particles, geometry;
        let animationId, cameraUtils, hands;
        let is3DInitialized = false;
        let targetPositions = [], originalPositions = [], randomPositions = [];
        let expansionFactor = 1.0, targetExpansion = 1.0, pulseTime = 0;

        // NAV
        function goSite(id) { switchView('view-site'); document.getElementById(id).scrollIntoView({behavior:'smooth'}); updateNavUI(id); }
        function goMode(mode) {
            currentMode = mode; switchView('view-3d');
            const t = document.getElementById('mode-title');
            if(mode === 'reactor') { t.innerText="REAKTÖR"; t.style.color="#ff0a43"; }
            else { t.innerText="HOLOGRAM"; t.style.color="#00e5ff"; }
            if(!is3DInitialized) document.getElementById('btn-start-3d').style.display = 'block';
            else { if(mode === 'hologram') loadHologramImage(); else setupReactor(); }
            updateNavUI(mode);
        }
        function switchView(id) { document.querySelectorAll('.view-layer').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function updateNavUI(id) { document.querySelectorAll('.nav-item').forEach(e=>{e.classList.remove('active'); if(e.onclick.toString().includes(id)) e.classList.add('active');}); }

        // 3D INIT
        function init3DSystem() {
            document.getElementById('btn-start-3d').style.display = 'none';
            const container = document.getElementById('canvas-container');
            container.innerHTML = '';
            
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.003);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 100;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);

            startCamera();
            if(currentMode==='reactor') setupReactor(); else loadHologramImage();
            animate();
            is3DInitialized = true;
        }

        // REACTOR
        function setupReactor() {
            if(particles) scene.remove(particles);
            geometry = new THREE.BufferGeometry();
            const pos = new Float32Array(PARTICLE_COUNT*3);
            const col = new Float32Array(PARTICLE_COUNT*3);
            targetPositions = [];
            const c = new THREE.Color(0xff0040);
            for(let i=0; i<PARTICLE_COUNT; i++) {
                const t=Math.random()*Math.PI*2, d=Math.pow(Math.random(),0.5);
                let x=16*Math.pow(Math.sin(t),3), y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t), z=(Math.random()-0.5)*12*d;
                targetPositions.push(x*1.5*d, y*1.5*d, z*1.5*d);
                pos[i*3]=(Math.random()-0.5)*500; pos[i*3+1]=(Math.random()-0.5)*500; pos[i*3+2]=(Math.random()-0.5)*500;
                col[i*3]=c.r; col[i*3+1]=c.g; col[i*3+2]=c.b;
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(col, 3));
            const mat = new THREE.PointsMaterial({size:2.5, vertexColors:true, blending:THREE.AdditiveBlending, transparent:true});
            particles = new THREE.Points(geometry, mat);
            scene.add(particles);
        }

        // HOLOGRAM
        function loadHologramImage() {
            const img = new Image(); img.src = PHOTO_URL;
            img.onload = () => {
                const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                const scale = 200/img.width; cvs.width=200; cvs.height=img.height*scale;
                ctx.drawImage(img,0,0,cvs.width,cvs.height);
                try { createHolo(ctx.getImageData(0,0,cvs.width,cvs.height)); } catch(e){ alert("Erreur Local"); }
            };
        }
        function createHolo(data) {
            if(particles) scene.remove(particles);
            geometry = new THREE.BufferGeometry();
            const w=data.width, h=data.height, d=data.data;
            const count=w*h; 
            const pos = [], col = [];
            originalPositions = []; randomPositions = [];
            
            for(let y=0; y<h; y++) {
                for(let x=0; x<w; x++) {
                    const i=(y*w+x)*4;
                    if(d[i+3]>50) {
                        const r=d[i]/255, g=d[i+1]/255, b=d[i+2]/255;
                        const px=(x-w/2)*0.8, py=(h/2-y)*0.8, pz=(r+g+b)*5;
                        pos.push(px, py, pz);
                        col.push(r,g,b);
                        originalPositions.push(px, py, pz);
                        randomPositions.push((Math.random()-0.5)*800, (Math.random()-0.5)*800, (Math.random()-0.5)*800);
                    }
                }
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(col, 3));
            const mat = new THREE.PointsMaterial({size:1.5, vertexColors:true, transparent:true});
            particles = new THREE.Points(geometry, mat);
            scene.add(particles);
        }

        // ANIMATION (NERVOUS)
        function animate() {
            requestAnimationFrame(animate);
            if(!particles) return;
            
            // Rotation STOP if hands detected to allow control
            if(currentMode === 'reactor') particles.rotation.y += 0.003;
            else { particles.rotation.y = 0; }

            const pos = geometry.attributes.position.array;
            expansionFactor += (targetExpansion - expansionFactor) * REACTION_SPEED;

            if(currentMode === 'reactor') {
                for(let i=0; i<pos.length; i++) {
                    pos[i] += (targetPositions[i]*expansionFactor - pos[i]) * REACTION_SPEED;
                }
            } else {
                const ratio = expansionFactor;
                for(let i=0; i<pos.length; i+=3) {
                    pos[i] = originalPositions[i/3] + (randomPositions[i/3] - originalPositions[i/3]) * ratio;
                    pos[i+1] = originalPositions[i/3+1] + (randomPositions[i/3+1] - originalPositions[i/3+1]) * ratio;
                    pos[i+2] = originalPositions[i/3+2] + (randomPositions[i/3+2] - originalPositions[i/3+2]) * ratio;
                }
            }
            geometry.attributes.position.needsUpdate = true;
            renderer.render(scene, camera);
        }

        // CAMERA
        function startCamera() {
            const vid = document.getElementById('webcam-video');
            const cvs = document.getElementById('pip-canvas');
            const ctx = cvs.getContext('2d');
            const stat = document.getElementById('status-3d');

            hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
            hands.setOptions({maxNumHands:2, modelComplexity:0, minDetectionConfidence:0.5});
            
            hands.onResults((res) => {
                // FORCE DRAW VIDEO
                ctx.save();
                ctx.clearRect(0,0,cvs.width,cvs.height);
                ctx.drawImage(res.image, 0, 0, cvs.width, cvs.height);
                if(res.multiHandLandmarks) {
                    for(const l of res.multiHandLandmarks) drawConnectors(ctx, l, HAND_CONNECTIONS, {color:'#00ff00', lineWidth:2});
                }
                ctx.restore();

                if(res.multiHandLandmarks.length > 0) {
                    stat.innerText = "CONNEXION OK !"; stat.style.color = "#00ffaa";
                    let dist = 0;
                    if(res.multiHandLandmarks.length === 2) {
                        const h1 = res.multiHandLandmarks[0][8], h2 = res.multiHandLandmarks[1][8];
                        dist = Math.sqrt(Math.pow(h1.x-h2.x,2)+Math.pow(h1.y-h2.y,2));
                    }
                    
                    if(currentMode === 'reactor') {
                        // Cœur : 1 main = un peu gros, 2 mains = distance
                        let val = (res.multiHandLandmarks.length === 2) ? dist * 7 : 1.5;
                        if(val<0.8) val=0.8; if(val>5) val=5;
                        targetExpansion = val;
                    } else {
                        // Hologram : 2 mains écartées = explosion
                        if(res.multiHandLandmarks.length === 2) {
                            let val = (dist - 0.2) * 3.0; 
                            if(val<0) val=0; if(val>1) val=1;
                            targetExpansion = val;
                        } else targetExpansion = 0;
                    }
                } else {
                    stat.innerText = "En attente..."; stat.style.color = "#fff";
                    if(currentMode === 'reactor') { pulseTime+=0.15; targetExpansion=1+Math.sin(pulseTime)*0.2; }
                    else targetExpansion=0;
                }
            });

            cameraUtils = new Camera(vid, {onFrame: async()=>{await hands.send({image:vid})}, width:320, height:240});
            cameraUtils.start();
        }

        // EXTRAS
        const startT = new Date('2024-11-13T00:00:00').getTime();
        setInterval(() => {
            const d = new Date().getTime() - startT;
            document.getElementById('d').innerText = Math.floor(d/(1000*60*60*24));
            document.getElementById('h').innerText = Math.floor((d%(1000*60*60*24))/(1000*60*60));
            document.getElementById('m').innerText = Math.floor((d%(1000*60*60))/(1000*60));
            document.getElementById('s').innerText = Math.floor((d%(1000*60))/1000);
        }, 1000);
        
        function openMsg() { document.getElementById('msg-text').innerText = "Seni seviyorum..."; }
        window.addEventListener('resize', ()=>{ if(camera){ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);} });
    </script>
</body>
</html>
